//Test_Math_26.cc - Test SVG contour export.

#include <iostream>
#include <cmath>
#include <functional>
#include <list>
#include <regex>
#include <limits>

#include "YgorMath.h"
#include "YgorPlot.h"
#include "YgorMisc.h"         //Needed for FUNCINFO, FUNCWARN, FUNCERR macros.
#include "YgorStats.h"        //Needed for Stats:: namespace.
#include "YgorString.h"       //Needed for GetFirstRegex(...)

#include "YgorMathIOSVG.h"

int main(int, char **){

    // A pair of lungs.
    std::stringstream ssA(R"***(17\74.1442953020134\18\74.1215277777778\18.546875\74\19\73.8956834532374\20\73.6746031746032\21\73.448051948052\22\73.2225609756098\22.9864864864865\73\23\72.99609375\24\72.7732919254658\25\72.5495689655172\26\72.3218085106383\27\72.0964285714286\27.421875\72\28\71.8715277777778\29\71.6472081218274\30\71.4230769230769\31\71.1774193548387\31.2412280701754\71\32\70.5471204188482\32.7798507462687\70\33\69.812101910828\34\69.1442953020134\34.1580882352941\69\35\68.4187817258883\35.6066176470588\68\36\67.7044198895028\37\67.01171875\37.0116279069767\67\38\66.3070652173913\38.4124087591241\66\39\65.5954773869347\39.8586956521739\65\40\64.8673469387755\41\64.203125\41.2355072463768\64\42\63.4828431372549\42.6840277777778\63\43\62.7369942196532\43.6505102040816\62\44\61.6107954545455\44.5375\61\45\60.4744318181818\45.4260204081633\60\46\59.3382352941177\46.3125\59\47\58.1993670886076\47.1981132075472\58\48\57.0693430656934\48.0693430656934\57\48.9423076923077\56\49\55.9427480916031\49.8233333333333\55\50\54.8256578947368\50.7011173184358\54\51\53.6907514450867\51.5857843137255\53\52\52.5598958333333\52.4694323144105\52\53\51.4130434782609\53.7125\51\53.9306569343066\50\54\49.8207547169811\54.2543859649123\49\54.5769230769231\48\54.8978873239437\47\55\46.71\55.217791411043\46\55.538626609442\45\55.8614864864865\44\56\43.5729166666667\56.1774193548387\43\56.5\42\56.8225806451613\41\57\40.4387755102041\57.1442953020134\40\57.4656652360515\39\57.787037037037\38\58\37.31\58.1083916083916\37\58.4256756756757\36\58.75\35\59\34.1826923076923\59.0693430656934\34\59.3983516483517\33\60\32.2122302158273\60.187898089172\32\60.3427835051546\31\60.5402542372881\30\60.7382352941177\29\60.9301470588235\28\61\27.6724137931034\61.1326530612245\27\61.328947368421\26\61.5270833333333\25\61.7228571428572\24\61.9166666666667\23\62\22.5892857142857\62.1145833333333\22\62.3145161290323\21\62.5123456790124\20\62.7106741573034\19\62.9035714285714\18\63\17.5178571428571\63.1021126760564\17\63.3011049723757\16\63.5\15\63.6950549450549\14\63.8908450704225\13\64\12.4464285714286\64.0892857142857\12\64.2893258426966\11\64.4855371900827\10\64.6818181818182\9\64.8724137931034\8\65\7.15909090909091\65.0267175572519\7\65.1809210526316\6\65.3359375\5\65.4918367346939\4\65.6472081218274\3\65.8032258064516\2\65.9583333333333\1\66\7.5e-1\66.1145833333333\0\66.2687861271676\-1\66.4256756756757\-2\66.5821917808219\-3\66.733918128655\-4\66.8908450704225\-5\67\-5.7045454545455\67.0485074626866\-6\67.1875\-7\67.5957943925234\-8\67.6875\-9\67.778125\-10\67.8636363636364\-11\67.9580152671756\-12\68\-12.458333333333\68.0488721804511\-13\68.1363636363636\-14\68.2253086419753\-15\68.3145161290323\-16\68.4042056074766\-17\68.4919678714859\-18\68.5821917808219\-19\68.6746031746032\-20\68.7606060606061\-21\68.851724137931\-22\68.9436090225564\-23\69\-23.625\69.0343511450382\-24\69.1232394366197\-25\69.2120253164557\-26\69.3011049723757\-27\69.38995215311\-28\69.4795918367347\-29\69.5691964285714\-30\69.6572164948454\-31\69.7470238095238\-32\69.8401360544218\-33\69.8884892086331\-34\69.8884892086331\-35\69.8884892086331\-36\69.8884892086331\-37\69.8884892086331\-38\69.8120567375886\-39\69\-39.47510373444\68\-39.923913043478\67.5961538461538\-40\67\-40.111510791367\66\-40.274566473988\65\-40.278735632184\64\-40.274566473988\63\-40.105839416058\62.42\-40\62\-39.923913043478\61\-39.598591549296\60\-39.263005780347\59.5054347826087\-39\59\-38.465517241379\58.7589285714286\-38\58\-37.483805668016\57.5161943319838\-37\57\-36.307065217391\56.5992907801418\-36\56\-35.514367816092\55.2149122807018\-35\55\-34.838815789474\54\-34.371921182266\53.5310559006211\-34\53\-33.525\52\-33.22256097561\51.7032520325203\-33\51\-32.542328042328\50\-32.217791411043\49.7090163934426\-32\49\-31.532432432432\48\-31.516597510373\47\-31.187898089172\46.3854166666667\-31\46\-30.867857142857\45\-30.835570469799\44\-30.60141509434\43\-30.5\42\-30.417808219178\41\-30.167808219178\40\-30.166666666667\39\-30.166666666667\38\-30.166666666667\37\-30.166666666667\36\-30.167808219178\35\-30.351282051282\34\-30.923913043478\33.86\-31\33\-31.3359375\32\-31.587557603687\31\-31.858620689655\30.5980392156863\-32\30\-32.193037974684\29\-32.529288702929\28\-32.529288702929\27\-32.533472803347\26\-32.529288702929\25\-32.52510460251\24\-32.520920502092\23\-32.529535864979\22\-32.144295302013\21.8537414965986\-32\21.0488721804511\-31\21\-30.889830508475\20.7067039106145\-30\20.3592964824121\-29\20.3560606060606\-28\20.3592964824121\-27\20.3560606060606\-26\20.3592964824121\-25\20.3560606060606\-24\20.3592964824121\-23\20.6129807692308\-22\20.6988950276243\-21\20.7027777777778\-20\21\-19.093220338983\21.0423076923077\-19\21.03515625\-18\21.2169811320755\-17\21.371921182266\-16\21.375\-15\21.3780487804878\-14\21.371921182266\-13\21.6950549450549\-12\21.7067039106145\-11\21.7106741573034\-10\21.7083333333333\-9\21.9803149606299\-8\22\-7.7222222222222\22.0485074626866\-7\22.0419847328244\-6\22.0503875968992\-5\22.2300613496933\-4\22.381067961165\-3\22.3780487804878\-2\22.5769230769231\-1\22.7212643678161\0\22.7270114942529\1\22.7228571428571\2\22.7270114942529\3\22.7228571428571\4\22.7270114942529\5\22.71875\6\22.7228571428571\7\22.71875\8\22.7228571428571\9\22.71875\10\22.7228571428571\11\22.7106741573034\12\22.4551282051282\13\22.3840579710145\14\22.2019230769231\15\22.0348837209302\16\22\16.0803571428571\21.7122905027933\17\21.5985915492958\18\21.2177914110429\19\21\19.71\20.8956834532374\20\20.6972222222222\21\20.0760869565217\22\20\22.2441860465116\19.7833333333333\23\19.4256756756757\24\19.0555555555556\25\19\25.0568181818182\18.3412698412698\26\18.1050724637681\27\18\27.1106870229008\17.4425837320574\28\17\28.4601990049751\16.4259259259259\29\16\29.9044943820225\15.9375\30\15.4597457627119\31\15\31.7919708029197\14.8006993006993\32\14.2177914110429\33\14\33.2398648648649\13.4791666666667\34\13\34.7900763358779\12.8154362416107\35\12.2433628318584\36\12\36.2330508474576\11.5848623853211\37\11\37.8173076923077\10.8149350649351\38\10.2365269461078\39\10\39.3464912280702\9.58839779005525\40\9.1421568627451\41\9\41.4833333333333\8.89160839160839\42\8.56919642857143\43\8.56919642857143\44\8.23101265822785\45\8.23006134969326\46\8.1875\47\8\47.4852941176471\7.87931034482759\48\7.89492753623189\49\7.89492753623189\50\7.89492753623189\51\7.89492753623189\52\7.89492753623189\53\7.89492753623189\54\7.89492753623189\55\7.90086206896552\56\8\56.2254901960784\8.23652694610779\57\8.23475609756098\58\8.23475609756098\59\8.23475609756098\60\8.23475609756098\61\8.234375\62\8.57174887892377\63\8.73823529411764\64\9\64.7063492063492\9.12671232876713\65\9.69125683060109\66\10\66.5885416666667\10.2365269461078\67\10.7727272727273\68\11\68.3826530612245\11.3235294117647\69\11.85\70\12\70.2045454545455\12.4107981220657\71\12.9586466165414\72\13\72.046218487395\14\72.8793103448276\14.2430555555556\73\15\73.3011049723757\16\73.7228571428571\16.6928571428571\74)***");
    std::stringstream ssB(R"***(-27\77.0340909090909\-26\77.01953125\-25\77.01953125\-24\77.3494897959184\-23\77.3494897959184\-22\77.3494897959184\-21\77.3494897959184\-20\77.3494897959184\-19\77.1611842105263\-18.681818181818\77\-18\76.4034090909091\-17.582352941176\76\-17\75.6721854304636\-16.161157024793\75\-16\74.8673469387755\-15.193037974684\74\-15\73.7896551724138\-14.170289855072\73\-14\72.7552083333333\-13.470802919708\72\-13\71.3418367346939\-12.791925465839\71\-12.166666666667\70\-12\69.80078125\-11.492574257426\69\-11.152482269504\68\-11\67.57\-10.817307692308\67\-10.287709497207\66\-10\65.2945205479452\-9.8547297297297\65\-9.81\64\-9.3625\63\-9.1423611111111\62\-9.028\61\-9\60.9\-8.8018867924528\60\-8.8032258064516\59\-8.4679487179487\58\-8.46875\57\-8.46875\56\-8.4665271966527\55\-8.46875\54\-8.46875\53\-8.46875\52\-8.4665271966527\51\-8.46875\50\-8.46875\49\-8.5723981900452\48\-8.796875\47\-9\46.3085106382979\-9.1283185840708\46\-9.1423611111111\45\-9.4744680851064\44\-9.812101910828\43\-10\42.0166666666667\-10.003937007874\42\-10.482062780269\41\-10.667539267016\40\-11\39.0078125\-11.00390625\39\-11.332460732984\38\-11.495884773663\37\-11.885416666667\36\-12\35.777027027027\-12.326704545455\35\-12.501984126984\34\-12.941860465116\33\-13\32.7794117647059\-13.172077922078\32\-13.607142857143\31\-13.845890410959\30\-13.980769230769\29\-14\28.969512195122\-14.384057971014\28\-14.516194331984\27\-14.712290502793\26\-15\25.2945205479452\-15.14527027027\25\-15.417808219178\24\-15.715517241379\23\-16\22.1160714285714\-16.048507462687\22\-16.201923076923\21\-16.381067961165\20\-16.640703517588\19\-16.843333333333\18\-17\17.3285714285714\-17.08273381295\17\-17.541666666667\16\-17.542553191489\15\-17.702777777778\14\-17.867346938776\13\-18\12.6454545454545\-18.243150684932\12\-18.5\11\-18.554347826087\10\-18.554347826087\9\-18.650510204082\8\-18.885416666667\7\-19\6.175\-19.027559055118\6\-19.225308641975\5\-19.226708074534\4\-19.225308641975\3\-19.226708074534\2\-19.226708074534\1\-19.226708074534\0\-19.225308641975\-1\-19.226708074534\-2\-19.560267857143\-3\-19.559210526316\-4\-19.561674008811\-5\-19.559210526316\-6\-19.561674008811\-7\-19.559210526316\-8\-19.559210526316\-9\-19.559210526316\-10\-19.559210526316\-11\-19.559210526316\-12\-19.559210526316\-13\-19.792993630573\-14\-19.895683453237\-15\-19.895683453237\-16\-19.901459854015\-17\-19.894927536232\-18\-19.895683453237\-19\-19.901459854015\-20\-19.901459854015\-21\-19.894927536232\-22\-19.901459854015\-23\-19.894927536232\-24\-19.901459854015\-25\-19.894927536232\-26\-19.894927536232\-27\-19.902173913043\-28\-19.902173913043\-29\-19.895683453237\-30\-19.895683453237\-31\-19.902173913043\-32\-19.894927536232\-33\-19.936567164179\-34\-20\-34.130769230769\-20.307065217391\-35\-20.60141509434\-36\-20.85\-37\-21\-37.197368421053\-21.598039215686\-38\-22\-38.621212121212\-23\-38.951492537313\-23.270833333333\-39\-24\-39.152173913043\-25\-39.297222222222\-26\-39.301104972376\-27\-39.297222222222\-28\-39.301104972376\-29\-39.297222222222\-30\-39.297222222222\-31\-39.297222222222\-32\-39.279527559055\-32.806818181818\-39\-33\-38.9375\-34\-38.96484375\-35\-38.859589041096\-36\-38.326923076923\-37\-38.293296089385\-38\-38.293296089385\-39\-38.261111111111\-39.712121212121\-38\-40\-37.930656934307\-41\-37.95703125\-42\-37.95703125\-43\-37.95703125\-44\-37.95703125\-45\-37.95703125\-46\-37.95703125\-47\-37.95703125\-48\-37.95703125\-49\-37.9375\-49.326923076923\-38\-50\-38.246478873239\-51\-38.465277777778\-52\-38.712290502793\-53\-38.9375\-53.113333333333\-39\-54\-39.627358490566\-54.647540983607\-40\-55\-40.144295302013\-56\-40.544392523364\-56.928571428571\-41\-57\-41.055555555556\-58\-41.544444444444\-59\-41.647208121827\-59.879746835443\-42\-60\-42.279411764706\-61\-42.748520710059\-62\-42.958646616541\-62.088709677419\-43\-63\-43.38698630137\-64\-43.671052631579\-65\-43.66935483871\-65.97619047619\-44\-66\-44.011627906977\-67\-44.149305555556\-68\-44.349489795918\-69\-44.549568965517\-69.634328358209\-44\-69.61004784689\-43\-69.584862385321\-42\-69.556768558952\-41\-69.53125\-40\-69.505952380952\-39\-69.479591836735\-38\-69.452789699571\-37\-69.428251121076\-36\-69.401408450704\-35\-69.375\-34\-69.349489795918\-33\-69.321808510638\-32\-69.297222222222\-31\-69.268786127168\-30\-69.243975903614\-29\-69.216981132075\-28\-69.191558441558\-27\-69.165540540541\-26\-69.142361111111\-25\-69.111510791367\-24\-69.084558823529\-23\-69.063909774436\-22\-69.034615384615\-21\-69.01171875\-20\-69\-19.625\-68.980620155039\-19\-68.914814814815\-18\-68.828859060403\-17\-68.747023809524\-16\-68.660621761658\-15\-68.576923076923\-14\-68.491967871486\-13\-68.406976744186\-12\-68.321808510638\-11\-68.239393939394\-10\-68.15306122449\-9\-68.07037037037\-8\-68\-7.1363636363636\-67.98828125\-7\-67.901459854015\-6\-67.819078947368\-5\-67.729651162791\-4\-67.647208121827\-3\-67.564159292035\-2\-67.477459016393\-1\-67.392857142857\0\-67.308743169399\1\-67.225308641975\2\-67.142361111111\3\-67.055970149254\4\-67\4.68181818181819\-66.973076923077\5\-66.888489208633\6\-66.803225806452\7\-66.71875\8\-66.634328358209\9\-66.450431034483\10\-66.248502994012\11\-66.048507462687\12\-66\12.2241379310345\-65.848993288591\13\-65.650510204082\14\-65.448051948052\15\-65.248502994012\16\-65.048507462687\17\-65\17.2241379310345\-64.848993288591\18\-64.647208121827\19\-64.448051948052\20\-64.248502994012\21\-64.048507462687\22\-64\22.2241379310345\-63.848993288591\23\-63.647208121827\24\-63.448051948052\25\-63.248502994012\26\-63.08273381295\27\-63\27.1385542168675\-62.579411764706\28\-62.226708074534\29\-62\29.688679245283\-61.885416666667\30\-61.548034934498\31\-61.205696202532\32\-61\32.625\-60.867346938776\33\-60.530042918455\34\-60.189102564103\35\-60\35.5673076923077\-59.85\36\-59.508583690987\37\-59.166666666667\38\-59\38.4903846153846\-58.827922077922\39\-58.487124463519\40\-58.15\41\-58\41.4326923076923\-57.810897435897\42\-57.467672413793\43\-57.138513513514\44\-57\44.3360655737705\-56.745283018868\45\-56.212962962963\46\-56\46.375\-55.678770949721\47\-55.155629139073\48\-55\48.2397959183673\-54.611979166667\49\-54.089285714286\50\-54\50.1168224299065\-53.54347826087\51\-53.011627906977\52\-53\52.0133928571429\-52.471291866029\53\-52\53.912037037037\-51.930656934307\54\-51.403553299492\55\-51\55.795\-50.861486486486\56\-50.337912087912\57\-50\57.6542553191489\-49.796875\58\-49.283707865169\59\-49\59.4764150943396\-48.675438596491\60\-48\60.6015625\-47.570224719101\61\-47\61.5178571428571\-46.469101123596\62\-46\62.4326424870466\-45.367052023121\63\-45\63.3432432432432\-44.268072289157\64\-44\64.2587209302326\-43.172077922078\65\-43\65.1720779220779\-42.076086956522\66\-42\66.0760869565217\-41\66.9806201550388\-40.980769230769\67\-40\67.8916083916084\-39.891608391608\68\-39\68.796875\-38.794303797468\69\-38\69.7090395480226\-37.695266272189\70\-37\70.625\-36.597142857143\71\-36\71.5386597938144\-35.494350282486\72\-35\72.4533678756477\-34.39367816092\73\-34\73.3663101604278\-33.04435483871\74\-33\74.0413533834586\-32\74.5892857142857\-31.225961538462\75\-31\75.1556291390728\-30\75.6994382022472\-29.448453608247\76\-29\76.2543859649123\-28\76.8243243243243\-27.1875\77)***");


    double nan = std::numeric_limits<double>::quiet_NaN();
    double x = nan;
    double y = nan;
    char dummy;

    contour_of_points<double> copA;
    while(ssA >> x >> dummy >> y){
        copA.points.emplace_back(vec3<double>(x,y,0.0));
        ssA >> dummy; // Consume the next separator char.
    }
    copA.metadata["ROIName"] = "patient's left lung";

    contour_of_points<double> copB;
    while(ssB >> x >> dummy >> y){
        copB.points.emplace_back(vec3<double>(x,y,0.0));
        ssB >> dummy; // Consume the next separator char.
    }
    copB.metadata["ROIName"] = "patient's right lung";

    // Rescale all coordinates by a constant factor.
    for(auto &p : copA.points){
        const double scale = 17.78 / 15.97; // AP field.
        p *= scale;
    }
    for(auto &p : copB.points){
        const double scale = 17.18 / 16.04; // PA field.
        p *= scale;
    }

    // Emit the scaled contour as a SVG file.
    {
        contour_collection<double> cc;
        cc.contours.emplace_back(copA);
        cc.contours.emplace_back(copB);
        cc.Insert_Metadata("TestKey1", "Test Value.");
        cc.Insert_Metadata("TestKey2", "+1.23E-45");
        cc.Insert_Metadata("TestKey3WithProblematicValue", "Malicious --> value that should be escaped.");

        const plane<double> P( vec3<double>(0.0, 0.0, 1.0),
                               vec3<double>(0.0, 0.0, 0.0) );
        std::ofstream os("/tmp/cc.svg");
        if(!WriteCCToSVG(cc, P, os, 5.0, 1.0, "ROI Name: $ROIName.")){
            FUNCERR("Unable to write contour collection to SVG file. Refusing to continue.");
        }
    }
    FUNCINFO("OK");

    return 0;
}

